{{ define "critical" }}
{{- $env := getenv "HUGO_ENV" -}}

{{/* <!--conditionally load and inline scripts--> */}}
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/fetch-inject" media="screen"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/3.0.0/plugins/rias/ls.rias.min.js"></script>
<script src="//cdn.jsdelivr.net/g/lazysizes(lazysizes.min.js)"></script>

{{- $vendor := resources.Get "js/vendor/jquery.min.js" | minify -}}
{{- $vendorpermalink := $vendor.Permalink -}}
{{- $.Scratch.Set "vendor" $vendorpermalink -}}
{{- $mainjs := resources.Get "js/main.js" | minify -}}
{{- $aos := resources.Get "js/plugins/aos.js" | minify -}}
{{- $highlightjs := resources.Get "js/plugins/highlight.min.js" -}}

{{- $lazysizesjs := resources.Get "js/plugins/lazysizes.min.js" -}}

{{- $file_path := replace .File.Path "." "-" -}}
{{- $file_path_clean := replace $file_path "/" "-" -}}
{{- $file_path_cleaned := replace $file_path_clean " " "" -}}
{{- $.Scratch.Set "preview_page_path" $file_path_cleaned -}}
{{- $preview_sections := trim .Sections "(0)" | lower -}}
{{- $.Scratch.Set "preview_link" $preview_sections -}}    

{{/* <!-- <script type="text/javascript">
  fetchInject([
    '{{- $lazysizesjs.Permalink -}}'
  ])
</script> --> */}}
{{- $clean_slug := replace .Params.slug "/" "" -}}
{{- $page_slug := $clean_slug -}}  

{{- $.Scratch.Set "is_css" true -}}
{{- $.Scratch.Set "is_critical" true -}}
{{/* <!--use on all environments for now--> */}}
<style class="critical">
    {{ partial "components/component_generator.html" . | safeCSS }}
</style>

{{- $env := getenv "HUGO_ENV" -}}
{{ if or (.Site.IsServer) (eq $env "") (eq $env "undefined") }}
{{/* <!--hide for now--> */}}
{{ end }}


{{- if eq .Site.Params.postcss_testing true }}
{{/* <!--use a resource for producition--> */}}
{{ $critical := resources.Get "scss/critical.scss" | resources.ExecuteAsTemplate "style.critical.scss" . | toCSS | minify }}

<style class="critical-postcss">{{ (slice $critical | resources.Concat "style.scss").Content | safeCSS }}</style>

{{ end }}


<script type="text/javascript">
fetchInject([
  '{{ $aos.Permalink }}'
], fetchInject([
  '{{ $vendor.Permalink }}',
])).then(() => {
      console.log(`Loaded aos & lazysizes`);
      AOS.init();
})
</script>

{{- $title := .Title -}}
{{- $page_hash := .UniqueID | urlize -}}

{{/* <!--check environment--> */}}


{{- if and (or (eq $env "undefined") (eq $env "") (eq $env "staging")) (eq $.Site.Params.debug_bar_settings.enable_debug true | default true)  }}

{{- $.Scratch.Set "debug_enabled" true -}}



{{- end -}}

{{ end }}